<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard Pro - ‡∏£‡πâ‡∏≤‡∏ô‡∏≠‡∏≤‡∏´‡∏≤‡∏£‡∏ô‡πâ‡∏≠‡∏á‡∏´‡∏ô‡∏∂‡πà‡∏áüê∞ü§ç</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Prompt:wght@300;400;500;600&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body { font-family: 'Prompt', sans-serif; }
        .loading-overlay { background: rgba(255,255,255,0.9); display: none; position: fixed; inset: 0; z-index: 9999; align-items: center; justify-content: center; flex-direction: column; }
        .toggle-checkbox:checked { right: 0; border-color: #10b981; }
        .toggle-checkbox:checked + .toggle-label { background-color: #10b981; }
        .nav-active { background-color: #10b981; color: white; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1); }
        .slide-up { animation: slideUp 0.3s ease-out forwards; }
        @keyframes slideUp { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
        .toast-anim { animation: slideIn 0.5s ease-out forwards; }
        @keyframes slideIn { from { transform: translateX(100%); opacity: 0; } to { transform: translateX(0); opacity: 1; } }
        .bell-ring { animation: ring 1s infinite ease-in-out; }
        @keyframes ring { 0% { transform: rotate(0); } 10% { transform: rotate(30deg); } 30% { transform: rotate(-28deg); } 50% { transform: rotate(34deg); } 70% { transform: rotate(-32deg); } 90% { transform: rotate(30deg); } 100% { transform: rotate(0); } }
    </style>
</head>
<body class="bg-slate-50 text-slate-800 font-sans h-screen flex overflow-hidden">

    <audio id="notif-sound" src="https://assets.mixkit.co/active_storage/sfx/2869/2869-preview.mp3" loop></audio>

    <div id="image-modal" class="fixed inset-0 bg-black/90 hidden z-[200] flex items-center justify-center p-4 backdrop-blur-sm" onclick="this.classList.add('hidden')">
        <img id="modal-img-src" src="" class="max-h-[90vh] max-w-full rounded-lg shadow-2xl transition-transform duration-300 transform hover:scale-105">
        <button class="absolute top-4 right-4 text-white text-4xl hover:text-red-500 transition">&times;</button>
    </div>

    <div id="notification-toast" class="fixed top-5 right-5 z-[100] hidden transition-transform hover:scale-105">
        <div class="relative bg-emerald-600 text-white shadow-2xl rounded-xl p-4 flex items-center toast-anim min-w-[320px] border-4 border-white cursor-pointer" onclick="openNewOrderModal()">
            <button onclick="closeToast(event)" class="absolute -top-3 -right-3 bg-white text-emerald-600 border-2 border-emerald-600 rounded-full w-8 h-8 flex items-center justify-center shadow-lg hover:bg-emerald-50 z-50 transition">
                <i class="fas fa-times text-lg font-bold"></i>
            </button>
            <div class="bg-white rounded-full p-3 mr-4">
                <i class="fas fa-bell text-emerald-600 text-2xl bell-ring"></i>
            </div>
            <div>
                <h4 class="font-bold text-lg">‡∏°‡∏µ‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå‡πÉ‡∏´‡∏°‡πà‡πÄ‡∏Ç‡πâ‡∏≤!</h4>
                <p class="text-sm text-emerald-100">‡∏Ñ‡∏•‡∏¥‡∏Å‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏î‡∏π‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ó‡∏±‡∏ô‡∏ó‡∏µ</p>
            </div>
        </div>
    </div>

    <div id="new-order-modal" class="fixed inset-0 bg-black bg-opacity-70 hidden z-[110] flex items-center justify-center p-4 backdrop-blur-sm">
        <div class="bg-white w-full max-w-sm rounded-2xl shadow-2xl overflow-hidden animate-bounce-in">
            <div class="bg-emerald-600 text-white p-4 text-center">
                <h3 class="text-xl font-bold"><i class="fas fa-concierge-bell mr-2"></i> ‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå‡πÉ‡∏´‡∏°‡πà‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î</h3>
            </div>
            <div class="p-6 text-center">
                <div class="mb-4">
                    <p class="text-slate-500 text-sm">‡πÇ‡∏ï‡πä‡∏∞</p>
                    <p id="modal-table" class="text-4xl font-bold text-slate-800">--</p>
                </div>
                <div class="bg-slate-50 p-4 rounded-xl border mb-4 text-left">
                    <p class="text-xs font-bold text-slate-400 mb-1">‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏™‡∏±‡πà‡∏á:</p>
                    <p id="modal-items" class="text-lg font-bold text-slate-700 leading-relaxed">Loading...</p>
                </div>
                <div class="flex justify-between items-center border-t pt-3">
                    <span class="text-slate-500">‡∏¢‡∏≠‡∏î‡∏£‡∏ß‡∏°</span>
                    <span id="modal-total" class="text-2xl font-bold text-emerald-600">‡∏ø0</span>
                </div>
            </div>
            <button onclick="acknowledgeOrder()" class="w-full bg-emerald-500 hover:bg-emerald-600 text-white font-bold py-4 text-lg transition">
                ‡∏£‡∏±‡∏ö‡∏ó‡∏£‡∏≤‡∏ö / ‡πÑ‡∏õ‡∏´‡∏ô‡πâ‡∏≤‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£ <i class="fas fa-arrow-right ml-2"></i>
            </button>
        </div>
    </div>

    <div id="loading" class="loading-overlay">
        <i class="fas fa-circle-notch fa-spin text-5xl text-emerald-500 mb-4"></i>
        <p class="font-bold text-slate-600 animate-pulse">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏õ‡∏£‡∏∞‡∏°‡∏ß‡∏•‡∏ú‡∏•‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...</p>
    </div>

    <div id="login-section" class="fixed inset-0 bg-white z-[100] flex items-center justify-center">
        <div class="w-full max-w-sm p-8 text-center">
            <div class="bg-emerald-100 w-24 h-24 rounded-full flex items-center justify-center mx-auto mb-6">
                <i class="fas fa-user-shield text-4xl text-emerald-500"></i>
            </div>
            <h2 class="text-3xl font-bold mb-2 text-slate-800">‡∏£‡πâ‡∏≤‡∏ô‡∏≠‡∏≤‡∏´‡∏≤‡∏£‡∏ô‡πâ‡∏≠‡∏á‡∏´‡∏ô‡∏∂‡πà‡∏áüê∞ü§ç</h2>
            <p class="text-slate-400 mb-8">‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏£‡πâ‡∏≤‡∏ô‡∏≠‡∏≤‡∏´‡∏≤‡∏£</p>
            <input type="password" id="admin-pin" placeholder="‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô (1234)" class="w-full p-4 bg-slate-50 border-2 border-slate-200 rounded-2xl mb-4 text-center text-xl focus:border-emerald-500 focus:outline-none transition">
            <button onclick="checkLogin()" class="w-full bg-emerald-500 text-white py-4 rounded-2xl font-bold text-lg hover:bg-emerald-600 shadow-lg hover:shadow-emerald-200 transition transform active:scale-95">‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö</button>
            <a href="index.html" class="block mt-6 text-slate-400 hover:text-emerald-500 text-sm">‡∏Å‡∏•‡∏±‡∏ö‡πÑ‡∏õ‡∏´‡∏ô‡πâ‡∏≤‡∏£‡πâ‡∏≤‡∏ô</a>
        </div>
    </div>

    <aside class="w-64 bg-white border-r hidden md:flex flex-col z-20">
        <div class="p-6 border-b">
            <h1 class="text-2xl font-bold text-emerald-600"><i class="fas fa-utensils mr-2"></i>‡∏£‡πâ‡∏≤‡∏ô‡∏≠‡∏≤‡∏´‡∏≤‡∏£‡∏ô‡πâ‡∏≠‡∏á‡∏´‡∏ô‡∏∂‡πà‡∏áüê∞ü§ç</h1>
        </div>
        <nav class="flex-1 p-4 space-y-2">
            <button onclick="switchTab('dashboard')" id="nav-dashboard" class="w-full text-left p-3 rounded-xl hover:bg-emerald-50 transition flex items-center text-slate-600"><i class="fas fa-chart-line w-8"></i> ‡∏™‡∏£‡∏∏‡∏õ‡∏¢‡∏≠‡∏î‡∏Ç‡∏≤‡∏¢</button>
            <button onclick="switchTab('orders')" id="nav-orders" class="w-full text-left p-3 rounded-xl hover:bg-emerald-50 transition flex items-center text-slate-600"><i class="fas fa-clipboard-list w-8"></i> ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠</button>
            <button onclick="switchTab('stock')" id="nav-stock" class="w-full text-left p-3 rounded-xl hover:bg-emerald-50 transition flex items-center text-slate-600"><i class="fas fa-box-open w-8"></i> ‡∏™‡∏ï‡πä‡∏≠‡∏Å‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</button>
        </nav>
        <div class="p-4 border-t">
            <div class="px-3 py-2 bg-green-50 rounded-lg mb-4 border border-green-200">
                <div class="flex items-center text-green-600 text-xs font-bold">
                    <span class="relative flex h-2 w-2 mr-2">
                      <span class="animate-ping absolute inline-flex h-full w-full rounded-full bg-green-400 opacity-75"></span>
                      <span class="relative inline-flex rounded-full h-2 w-2 bg-green-500"></span>
                    </span>
                    ‡∏£‡∏∞‡∏ö‡∏ö‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡∏ó‡∏≥‡∏á‡∏≤‡∏ô
                </div>
            </div>
            <button onclick="logout()" class="w-full text-left p-3 rounded-xl text-red-500 hover:bg-red-50 transition flex items-center"><i class="fas fa-sign-out-alt w-8"></i> ‡∏≠‡∏≠‡∏Å‡∏£‡∏∞‡∏ö‡∏ö</button>
        </div>
    </aside>

    <main class="flex-1 flex flex-col h-screen overflow-hidden relative">
        <header class="bg-white border-b p-4 md:hidden flex justify-between items-center z-10">
            <h1 class="font-bold text-emerald-600 text-lg">‡∏£‡πâ‡∏≤‡∏ô‡∏≠‡∏≤‡∏´‡∏≤‡∏£‡∏ô‡πâ‡∏≠‡∏á‡∏´‡∏ô‡∏∂‡πà‡∏áüê∞ü§ç</h1>
            <button onclick="logout()" class="text-red-500"><i class="fas fa-sign-out-alt"></i></button>
        </header>

        <div class="flex-1 overflow-y-auto p-4 md:p-8 pb-24 md:pb-8 bg-slate-50" id="main-container">
            
            <div id="view-dashboard" class="space-y-6 hidden slide-up">
                <div class="flex flex-col md:flex-row justify-between items-start md:items-end gap-4">
                    <div>
                        <h2 class="text-2xl font-bold text-slate-800">‡∏™‡∏£‡∏∏‡∏õ‡∏¢‡∏≠‡∏î‡∏Ç‡∏≤‡∏¢</h2>
                        <p class="text-slate-500 text-sm">‡∏†‡∏≤‡∏û‡∏£‡∏ß‡∏°‡∏£‡∏≤‡∏¢‡πÑ‡∏î‡πâ‡πÅ‡∏•‡∏∞‡∏Å‡∏≤‡∏£‡∏Ñ‡∏≤‡∏î‡∏Å‡∏≤‡∏£‡∏ì‡πå</p>
                    </div>
                    <div class="flex items-center gap-2 w-full md:w-auto">
                        <div id="custom-date-wrap" class="hidden">
                            <input type="date" id="dash-custom-date" class="bg-white border-2 border-emerald-100 p-2 rounded-xl text-sm text-slate-700 font-bold focus:border-emerald-500 outline-none shadow-sm cursor-pointer" onchange="refreshDashboard()">
                        </div>
                        <select id="dash-period" class="bg-white border-2 border-emerald-100 p-2 rounded-xl text-sm text-slate-700 font-bold focus:border-emerald-500 outline-none shadow-sm cursor-pointer w-full md:w-auto" onchange="handlePeriodChange()">
                            <option value="today">‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ (‡∏£‡∏≤‡∏¢‡∏ä‡∏±‡πà‡∏ß‡πÇ‡∏°‡∏á)</option>
                            <option value="yesterday">‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏ß‡∏≤‡∏ô (‡∏¢‡∏≠‡∏î‡∏Ç‡∏≤‡∏¢‡∏¢‡πâ‡∏≠‡∏ô‡∏´‡∏•‡∏±‡∏á)</option>
                            <option value="custom">üìÖ ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏≠‡∏á...</option>
                            <option value="week">‡∏™‡∏±‡∏õ‡∏î‡∏≤‡∏´‡πå‡∏ô‡∏µ‡πâ (‡∏£‡∏≤‡∏¢‡∏ß‡∏±‡∏ô)</option>
                            <option value="month">‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏ô‡∏µ‡πâ (‡∏£‡∏≤‡∏¢‡∏ß‡∏±‡∏ô)</option>
                            <option value="quarter">‡πÑ‡∏ï‡∏£‡∏°‡∏≤‡∏™‡∏ô‡∏µ‡πâ (‡∏£‡∏≤‡∏¢‡πÄ‡∏î‡∏∑‡∏≠‡∏ô)</option>
                            <option value="year">‡∏õ‡∏µ‡∏ô‡∏µ‡πâ (‡∏£‡∏≤‡∏¢‡πÄ‡∏î‡∏∑‡∏≠‡∏ô)</option>
                        </select>
                    </div>
                </div>
                
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                    <div class="bg-white p-6 rounded-2xl shadow-sm border border-slate-100 relative overflow-hidden">
                        <div class="absolute -right-4 -top-4 text-emerald-100 opacity-50"><i class="fas fa-wallet text-6xl"></i></div>
                        <p class="text-slate-400 text-xs font-bold uppercase relative z-10">‡∏¢‡∏≠‡∏î‡∏Ç‡∏≤‡∏¢‡∏£‡∏ß‡∏°</p>
                        <h3 class="text-3xl font-bold text-emerald-500 mt-2 relative z-10">‡∏ø<span id="stat-total">0</span></h3>
                    </div>
                    <div class="bg-white p-6 rounded-2xl shadow-sm border border-slate-100 relative overflow-hidden">
                        <div class="absolute -right-4 -top-4 text-blue-100 opacity-50"><i class="fas fa-receipt text-6xl"></i></div>
                        <p class="text-slate-400 text-xs font-bold uppercase relative z-10">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå</p>
                        <h3 class="text-3xl font-bold text-blue-500 mt-2 relative z-10"><span id="stat-count">0</span> <span class="text-sm text-slate-400 font-normal">‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</span></h3>
                    </div>
                    <div class="bg-white p-6 rounded-2xl shadow-sm border border-slate-100 relative overflow-hidden">
                        <div class="absolute -right-4 -top-4 text-amber-100 opacity-50"><i class="fas fa-chart-pie text-6xl"></i></div>
                        <p class="text-slate-400 text-xs font-bold uppercase relative z-10">‡πÄ‡∏â‡∏•‡∏µ‡πà‡∏¢‡∏ï‡πà‡∏≠‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå</p>
                        <h3 class="text-3xl font-bold text-amber-500 mt-2 relative z-10">‡∏ø<span id="stat-avg">0</span></h3>
                    </div>
                </div>
                <div class="bg-white p-6 rounded-2xl shadow-sm border border-slate-100">
                    <h4 class="font-bold mb-4 text-slate-700 flex items-center gap-2">
                        <i class="fas fa-chart-area text-emerald-500"></i> ‡πÅ‡∏ô‡∏ß‡πÇ‡∏ô‡πâ‡∏°‡∏¢‡∏≠‡∏î‡∏Ç‡∏≤‡∏¢ & ‡∏Ñ‡∏≤‡∏î‡∏Å‡∏≤‡∏£‡∏ì‡πå (Forecast)
                    </h4>
                    <div class="relative h-[350px] w-full">
                        <canvas id="chart-sales"></canvas>
                    </div>
                </div>
            </div>

            <div id="view-orders" class="space-y-6 hidden slide-up">
                <div class="flex flex-col md:flex-row justify-between items-start md:items-center gap-4 bg-white p-4 rounded-2xl shadow-sm border border-slate-100">
                    <div>
                        <h2 class="text-xl font-bold text-slate-800">‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠</h2>
                        <p class="text-xs text-slate-400">‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå‡πÅ‡∏•‡∏∞‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</p>
                    </div>
                    <div class="flex flex-wrap items-center gap-2 w-full md:w-auto">
                        <div id="orders-custom-date-wrap" class="hidden">
                            <input type="date" id="orders-custom-date" class="bg-white border-2 border-emerald-100 p-2 rounded-xl text-sm text-slate-700 font-bold focus:border-emerald-500 outline-none shadow-sm cursor-pointer" onchange="refreshOrders()">
                        </div>
                        <select id="orders-period" class="bg-white border-2 border-emerald-100 p-2 rounded-xl text-sm text-slate-700 font-bold focus:border-emerald-500 outline-none shadow-sm cursor-pointer flex-1 md:flex-none" onchange="handleOrdersPeriodChange()">
                            <option value="today">‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ</option>
                            <option value="yesterday">‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏ß‡∏≤‡∏ô</option>
                            <option value="custom">üìÖ ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏≠‡∏á...</option>
                            <option value="week">‡∏™‡∏±‡∏õ‡∏î‡∏≤‡∏´‡πå‡∏ô‡∏µ‡πâ</option>
                            <option value="month">‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏ô‡∏µ‡πâ</option>
                            <option value="quarter">‡πÑ‡∏ï‡∏£‡∏°‡∏≤‡∏™‡∏ô‡∏µ‡πâ</option>
                            <option value="year">‡∏õ‡∏µ‡∏ô‡∏µ‡πâ</option>
                            <option value="all">‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î (All)</option>
                        </select>
                        <button onclick="refreshOrders()" class="bg-emerald-100 text-emerald-600 p-2 rounded-xl hover:bg-emerald-200 transition font-bold text-sm px-4"><i class="fas fa-sync-alt"></i></button>
                    </div>
                </div>
                <div id="orders-list" class="space-y-4"></div>
            </div>

            <div id="view-stock" class="space-y-6 hidden slide-up">
                <div class="flex justify-between items-center bg-white p-4 rounded-2xl shadow-sm border border-slate-100">
                    <h2 class="text-xl font-bold text-slate-800">‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏™‡∏ï‡πä‡∏≠‡∏Å</h2>
                    <button onclick="openForm()" class="bg-emerald-500 text-white px-4 py-2 rounded-lg text-sm font-bold shadow hover:bg-emerald-600 transition"><i class="fas fa-plus mr-1"></i> ‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏°‡∏ô‡∏π</button>
                </div>
                <div class="flex space-x-2 overflow-x-auto no-scrollbar pb-2">
                    <button onclick="filterStock('all')" class="stock-filter active bg-emerald-500 text-white px-4 py-1.5 rounded-full text-sm font-bold whitespace-nowrap transition">‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</button>
                    <button onclick="filterStock('food')" class="stock-filter bg-white text-slate-600 border px-4 py-1.5 rounded-full text-sm font-bold whitespace-nowrap transition shadow-sm">‡∏≠‡∏≤‡∏´‡∏≤‡∏£</button>
                    <button onclick="filterStock('drink')" class="stock-filter bg-white text-slate-600 border px-4 py-1.5 rounded-full text-sm font-bold whitespace-nowrap transition shadow-sm">‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏î‡∏∑‡πà‡∏°</button>
                    <button onclick="filterStock('dessert')" class="stock-filter bg-white text-slate-600 border px-4 py-1.5 rounded-full text-sm font-bold whitespace-nowrap transition shadow-sm">‡∏Ç‡∏≠‡∏á‡∏´‡∏ß‡∏≤‡∏ô</button>
                </div>
                <div id="stock-grid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-4"></div>
            </div>

        </div>

        <div class="md:hidden fixed bottom-0 w-full bg-white border-t flex justify-around p-3 z-20 text-xs font-bold text-slate-400">
            <button onclick="switchTab('dashboard')" id="mob-dashboard" class="flex flex-col items-center gap-1"><i class="fas fa-chart-line text-lg"></i> ‡∏™‡∏£‡∏∏‡∏õ‡∏¢‡∏≠‡∏î</button>
            <button onclick="switchTab('orders')" id="mob-orders" class="flex flex-col items-center gap-1"><i class="fas fa-clipboard-list text-lg"></i> ‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå</button>
            <button onclick="switchTab('stock')" id="mob-stock" class="flex flex-col items-center gap-1"><i class="fas fa-box-open text-lg"></i> ‡∏™‡∏ï‡πä‡∏≠‡∏Å</button>
        </div>
    </main>

    <div id="product-form" class="fixed inset-0 bg-black/60 z-50 hidden flex items-center justify-center p-4 backdrop-blur-sm">
        <div class="bg-white w-full max-w-lg rounded-3xl p-6 shadow-2xl relative animate-fade-in max-h-[90vh] overflow-y-auto">
            <h3 id="form-title" class="text-xl font-bold mb-4 text-slate-800">‡πÄ‡∏û‡∏¥‡πà‡∏°/‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç ‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</h3>
            <input type="hidden" id="edit-old-name">
            <div class="space-y-3">
                <input type="text" id="menu-name" placeholder="‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤" class="w-full p-3 border rounded-xl bg-slate-50 focus:bg-white transition focus:border-emerald-500 outline-none">
                <div class="flex gap-2">
                    <input type="number" id="menu-price" placeholder="‡∏£‡∏≤‡∏Ñ‡∏≤" class="w-1/2 p-3 border rounded-xl bg-slate-50 focus:bg-white transition focus:border-emerald-500 outline-none">
                    <select id="menu-type" class="w-1/2 p-3 border rounded-xl bg-slate-50 text-slate-600 focus:border-emerald-500 outline-none">
                        <option value="food">‡∏≠‡∏≤‡∏´‡∏≤‡∏£</option>
                        <option value="drink">‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏î‡∏∑‡πà‡∏°</option>
                        <option value="dessert">‡∏Ç‡∏≠‡∏á‡∏´‡∏ß‡∏≤‡∏ô</option>
                    </select>
                </div>
                
                <div class="bg-emerald-50/50 p-4 rounded-xl border border-emerald-100">
                    <label class="flex items-center justify-between cursor-pointer mb-2">
                        <span class="font-bold text-emerald-800 text-sm">‡∏Å‡∏≤‡∏£‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏™‡∏ï‡πä‡∏≠‡∏Å</span>
                        <div class="flex items-center">
                            <input type="checkbox" id="menu-unlimited" class="w-4 h-4 text-emerald-500 rounded focus:ring-emerald-500 mr-2 cursor-pointer" onchange="toggleStockInput()">
                            <span class="text-sm text-slate-600 font-medium">‡∏°‡∏µ‡πÑ‡∏°‡πà‡∏à‡∏≥‡∏Å‡∏±‡∏î (‚àû)</span>
                        </div>
                    </label>
                    <input type="number" id="menu-stock" placeholder="‡πÉ‡∏™‡πà‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ó‡∏µ‡πà‡∏°‡∏µ (‡∏ä‡∏¥‡πâ‡∏ô/‡∏à‡∏≤‡∏ô)" class="w-full p-3 border rounded-xl bg-white transition-all focus:border-emerald-500 outline-none">
                </div>

                <textarea id="menu-desc" placeholder="‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î (‡πÑ‡∏°‡πà‡πÉ‡∏™‡πà‡∏Å‡πá‡πÑ‡∏î‡πâ)" class="w-full p-3 border rounded-xl bg-slate-50 focus:bg-white transition focus:border-emerald-500 outline-none" rows="2"></textarea>
                <div class="border-dashed border-2 border-slate-300 rounded-xl p-6 text-center cursor-pointer hover:bg-slate-50 transition relative overflow-hidden group">
                    <input type="file" id="menu-image" class="absolute inset-0 opacity-0 cursor-pointer z-10">
                    <i class="fas fa-cloud-upload-alt text-emerald-400 text-3xl mb-2 group-hover:scale-110 transition"></i>
                    <p class="text-sm font-bold text-slate-600">‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û‡πÉ‡∏´‡∏°‡πà</p>
                    <p class="text-xs text-slate-400 mt-1">‡πÅ‡∏ï‡∏∞‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡∏π‡∏õ</p>
                </div>
            </div>
            <div class="flex gap-3 mt-6">
                <button onclick="closeForm()" class="flex-1 py-3 bg-slate-200 rounded-xl font-bold text-slate-600 hover:bg-slate-300 transition">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
                <button onclick="saveProduct()" class="flex-1 py-3 bg-emerald-500 rounded-xl font-bold text-white hover:bg-emerald-600 shadow-lg shadow-emerald-200 transition">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</button>
            </div>
        </div>
    </div>

    <div id="time-modal" class="fixed inset-0 bg-black/60 z-[60] hidden flex items-center justify-center p-4 backdrop-blur-sm">
        <div class="bg-white w-full max-w-sm rounded-3xl p-6 text-center shadow-2xl">
            <h3 class="text-lg font-bold mb-4 text-slate-800">‚è≥ ‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ß‡∏•‡∏≤‡∏õ‡∏£‡∏∏‡∏á‡∏≠‡∏≤‡∏´‡∏≤‡∏£‡πÉ‡∏´‡πâ‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤</h3>
            <div class="grid grid-cols-3 gap-3 mb-6">
                <button onclick="selectTime('10 ‡∏ô‡∏≤‡∏ó‡∏µ')" class="p-3 border-2 border-slate-100 rounded-xl hover:border-emerald-400 hover:bg-emerald-50 transition text-sm font-bold text-slate-600">10 ‡∏ô‡∏≤‡∏ó‡∏µ</button>
                <button onclick="selectTime('15 ‡∏ô‡∏≤‡∏ó‡∏µ')" class="p-3 border-2 border-slate-100 rounded-xl hover:border-emerald-400 hover:bg-emerald-50 transition text-sm font-bold text-slate-600">15 ‡∏ô‡∏≤‡∏ó‡∏µ</button>
                <button onclick="selectTime('20 ‡∏ô‡∏≤‡∏ó‡∏µ')" class="p-3 border-2 border-slate-100 rounded-xl hover:border-emerald-400 hover:bg-emerald-50 transition text-sm font-bold text-slate-600">20 ‡∏ô‡∏≤‡∏ó‡∏µ</button>
                <button onclick="selectTime('30 ‡∏ô‡∏≤‡∏ó‡∏µ')" class="p-3 border-2 border-slate-100 rounded-xl hover:border-emerald-400 hover:bg-emerald-50 transition text-sm font-bold text-slate-600">30 ‡∏ô‡∏≤‡∏ó‡∏µ</button>
                <button onclick="selectTime('45 ‡∏ô‡∏≤‡∏ó‡∏µ')" class="p-3 border-2 border-slate-100 rounded-xl hover:border-emerald-400 hover:bg-emerald-50 transition text-sm font-bold text-slate-600">45 ‡∏ô‡∏≤‡∏ó‡∏µ</button>
                <button onclick="selectTime('1 ‡∏ä‡∏°.')" class="p-3 border-2 border-slate-100 rounded-xl hover:border-emerald-400 hover:bg-emerald-50 transition text-sm font-bold text-slate-600">1 ‡∏ä‡∏°.</button>
            </div>
            <button onclick="document.getElementById('time-modal').classList.add('hidden')" class="text-slate-400 hover:text-slate-600 text-sm font-bold underline">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
        </div>
    </div>

    <script>
        const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbwPX7-03fHsRh63WwTdLEU-RzSRUPwBpCCFVKVKDMBpiRbz-2H7L_ytpEZA17TADcWPBw/exec'; 
        const PIN = "1234";
        
        let allOrders = [];
        let allMenu = [];
        let pendingRowIndex = null;
        let chartSales = null;
        let lastOrderCount = -1;
        let latestOrderData = null;
        let currentTab = 'dashboard'; 

        function unlockAudioContext() {
            const audio = document.getElementById('notif-sound');
            audio.play().then(() => { audio.pause(); audio.currentTime = 0; }).catch(e => {});
        }

        window.addEventListener('DOMContentLoaded', () => {
            window.addEventListener('click', unlockAudioContext, { once: true });
            
            // ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ Date Picker ‡πÉ‡∏´‡πâ‡πÄ‡∏õ‡πá‡∏ô‡∏Ñ‡πà‡∏≤‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ
            const todayStr = new Date().toISOString().split('T')[0];
            document.getElementById('dash-custom-date').value = todayStr;
            document.getElementById('orders-custom-date').value = todayStr;

            if (localStorage.getItem('admin_logged_in') === 'true') {
                document.getElementById('login-section').classList.add('hidden');
                switchTab('dashboard');
                startPollingLoop(); 
            }
        });

        function startPollingLoop() {
            checkForNewOrders(); 
            setInterval(checkForNewOrders, 5000); 
        }

        async function checkForNewOrders() {
            try {
                const res = await fetch(`${SCRIPT_URL}?action=getOrders`);
                const data = await res.json();
                const currentCount = data.length - 1;

                if (lastOrderCount !== -1 && currentCount > lastOrderCount) {
                    latestOrderData = data[data.length - 1]; 
                    playAlarm();
                    showPersistentToast();
                    if (currentTab === 'orders') {
                        allOrders = data;
                        renderOrders();
                    }
                }
                lastOrderCount = currentCount;
                if(currentTab === 'orders') allOrders = data; 
            } catch (err) {}
        }

        function playAlarm() {
            const audio = document.getElementById('notif-sound');
            audio.currentTime = 0;
            audio.play().catch(e => console.log("Audio still blocked"));
        }
        function stopAlarm() {
            const audio = document.getElementById('notif-sound');
            audio.pause();
            audio.currentTime = 0;
        }
        
        function closeToast(event) {
            event.stopPropagation(); 
            document.getElementById('notification-toast').classList.add('hidden');
            stopAlarm();
        }

        function showPersistentToast() { document.getElementById('notification-toast').classList.remove('hidden'); }
        function openNewOrderModal() {
            if (!latestOrderData) return;
            document.getElementById('modal-table').innerText = latestOrderData[1];
            document.getElementById('modal-items').innerText = latestOrderData[2];
            document.getElementById('modal-total').innerText = "‡∏ø" + latestOrderData[3];
            document.getElementById('new-order-modal').classList.remove('hidden');
            document.getElementById('notification-toast').classList.add('hidden');
        }
        function acknowledgeOrder() {
            stopAlarm();
            document.getElementById('new-order-modal').classList.add('hidden');
            switchTab('orders');
        }

        function checkLogin() {
            if (document.getElementById('admin-pin').value === PIN) {
                localStorage.setItem('admin_logged_in', 'true');
                document.getElementById('login-section').classList.add('hidden');
                unlockAudioContext();
                switchTab('dashboard');
                startPollingLoop();
            } else alert("‡∏£‡∏´‡∏±‡∏™‡∏ú‡∏¥‡∏î");
        }
        function logout() { localStorage.removeItem('admin_logged_in'); location.reload(); }

        function switchTab(tabName) {
            currentTab = tabName; 
            ['dashboard', 'orders', 'stock'].forEach(t => document.getElementById(`view-${t}`).classList.add('hidden'));
            document.querySelectorAll('aside nav button').forEach(b => b.classList.remove('nav-active'));
            document.querySelectorAll('.md\\:hidden button').forEach(b => b.classList.remove('text-emerald-500'));

            document.getElementById(`view-${tabName}`).classList.remove('hidden');
            if(document.getElementById(`nav-${tabName}`)) document.getElementById(`nav-${tabName}`).classList.add('nav-active');
            if(document.getElementById(`mob-${tabName}`)) document.getElementById(`mob-${tabName}`).classList.add('text-emerald-500');

            if (tabName === 'dashboard') refreshDashboard();
            else if (tabName === 'orders') refreshOrders();
            else if (tabName === 'stock') refreshStock();
        }

        // --- DASHBOARD LOGIC ---
        function handlePeriodChange() {
            const period = document.getElementById('dash-period').value;
            const customDateWrap = document.getElementById('custom-date-wrap');
            if (period === 'custom') customDateWrap.classList.remove('hidden');
            else customDateWrap.classList.add('hidden');
            refreshDashboard();
        }

        async function refreshDashboard() {
            toggleLoading(true);
            try {
                const res = await fetch(`${SCRIPT_URL}?action=getOrders`);
                const data = await res.json();
                allOrders = data.slice(1); 
                renderCharts();
            } catch(e) {}
            toggleLoading(false);
        }

        function renderCharts() {
            const period = document.getElementById('dash-period').value;
            const now = new Date();
            const yesterday = new Date(now); yesterday.setDate(yesterday.getDate() - 1);
            let customDate = new Date();
            if (period === 'custom') {
                const cdVal = document.getElementById('dash-custom-date').value;
                if(cdVal) customDate = new Date(cdVal);
            }

            let labels = [];
            let actualData = [];
            let predictData = [];
            let dataMap = {};
            let filteredOrders = [];

            if (period === 'today' || period === 'yesterday' || period === 'custom') {
                labels = Array.from({length: 24}, (_, i) => `${String(i).padStart(2, '0')}:00`);
                labels.forEach(l => dataMap[l] = 0);
                
                let targetDateStr = '';
                if (period === 'today') targetDateStr = now.toDateString();
                else if (period === 'yesterday') targetDateStr = yesterday.toDateString();
                else if (period === 'custom') targetDateStr = customDate.toDateString();

                filteredOrders = allOrders.filter(r => new Date(r[0]).toDateString() === targetDateStr);
                filteredOrders.forEach(r => {
                    let h = new Date(r[0]).getHours();
                    dataMap[`${String(h).padStart(2, '0')}:00`] += parseInt(r[3]) || 0;
                });
            } 
            else if (period === 'week') {
                labels = ['‡∏à.', '‡∏≠.', '‡∏û.', '‡∏û‡∏§.', '‡∏®.', '‡∏™.', '‡∏≠‡∏≤.'];
                labels.forEach(l => dataMap[l] = 0);
                
                const currentDay = now.getDay() === 0 ? 7 : now.getDay(); 
                const monday = new Date(now); 
                monday.setDate(now.getDate() - currentDay + 1);
                monday.setHours(0,0,0,0);
                
                filteredOrders = allOrders.filter(r => new Date(r[0]) >= monday && new Date(r[0]).getTime() <= now.getTime() + 86400000);
                filteredOrders.forEach(r => {
                    let dayIdx = new Date(r[0]).getDay();
                    let dayName = ['‡∏≠‡∏≤.', '‡∏à.', '‡∏≠.', '‡∏û.', '‡∏û‡∏§.', '‡∏®.', '‡∏™.'][dayIdx];
                    dataMap[dayName] += parseInt(r[3]) || 0;
                });
            }
            else if (period === 'month') {
                const daysInMonth = new Date(now.getFullYear(), now.getMonth() + 1, 0).getDate();
                labels = Array.from({length: daysInMonth}, (_, i) => `${i + 1}`);
                labels.forEach(l => dataMap[l] = 0);
                filteredOrders = allOrders.filter(r => new Date(r[0]).getMonth() === now.getMonth() && new Date(r[0]).getFullYear() === now.getFullYear());
                filteredOrders.forEach(r => {
                    let d = new Date(r[0]).getDate();
                    dataMap[`${d}`] += parseInt(r[3]) || 0;
                });
            } 
            else if (period === 'quarter') {
                const q = Math.floor((now.getMonth() + 3) / 3);
                const qStartMonth = (q - 1) * 3; 
                const monthNames = ['‡∏°.‡∏Ñ.', '‡∏Å.‡∏û.', '‡∏°‡∏µ.‡∏Ñ.', '‡πÄ‡∏°.‡∏¢.', '‡∏û.‡∏Ñ.', '‡∏°‡∏¥.‡∏¢.', '‡∏Å.‡∏Ñ.', '‡∏™.‡∏Ñ.', '‡∏Å.‡∏¢.', '‡∏ï.‡∏Ñ.', '‡∏û.‡∏¢.', '‡∏ò.‡∏Ñ.'];
                labels = [monthNames[qStartMonth], monthNames[qStartMonth+1], monthNames[qStartMonth+2]];
                labels.forEach(l => dataMap[l] = 0);
                
                filteredOrders = allOrders.filter(r => {
                    const d = new Date(r[0]);
                    const rowQ = Math.floor((d.getMonth() + 3) / 3);
                    return q === rowQ && d.getFullYear() === now.getFullYear();
                });
                filteredOrders.forEach(r => {
                    let m = new Date(r[0]).getMonth();
                    dataMap[monthNames[m]] += parseInt(r[3]) || 0;
                });
            }
            else if (period === 'year') {
                labels = ['‡∏°.‡∏Ñ.', '‡∏Å.‡∏û.', '‡∏°‡∏µ.‡∏Ñ.', '‡πÄ‡∏°.‡∏¢.', '‡∏û.‡∏Ñ.', '‡∏°‡∏¥.‡∏¢.', '‡∏Å.‡∏Ñ.', '‡∏™.‡∏Ñ.', '‡∏Å.‡∏¢.', '‡∏ï.‡∏Ñ.', '‡∏û.‡∏¢.', '‡∏ò.‡∏Ñ.'];
                labels.forEach(l => dataMap[l] = 0);
                filteredOrders = allOrders.filter(r => new Date(r[0]).getFullYear() === now.getFullYear());
                filteredOrders.forEach(r => {
                    let m = new Date(r[0]).getMonth();
                    dataMap[labels[m]] += parseInt(r[3]) || 0;
                });
            }

            let currentLabelIndex = -1;
            if (period === 'today') currentLabelIndex = now.getHours();
            else if (period === 'yesterday') currentLabelIndex = 23; 
            else if (period === 'custom') {
                customDate.setHours(0,0,0,0);
                const todayZero = new Date(now); todayZero.setHours(0,0,0,0);
                if (customDate.getTime() < todayZero.getTime()) currentLabelIndex = 23; 
                else if (customDate.getTime() === todayZero.getTime()) currentLabelIndex = now.getHours(); 
                else currentLabelIndex = -1; 
            }
            else if (period === 'week') currentLabelIndex = (now.getDay() === 0 ? 7 : now.getDay()) - 1;
            else if (period === 'month') currentLabelIndex = now.getDate() - 1;
            else if (period === 'quarter') {
                const qStartMonth = (Math.floor((now.getMonth() + 3) / 3) - 1) * 3;
                currentLabelIndex = now.getMonth() - qStartMonth;
            }
            else if (period === 'year') currentLabelIndex = now.getMonth();

            let totalSalesSoFar = 0;
            let countUnits = currentLabelIndex + 1; 
            
            for (let i = 0; i <= currentLabelIndex; i++) {
                if(dataMap[labels[i]]) totalSalesSoFar += dataMap[labels[i]];
            }
            
            let avgSales = countUnits > 0 ? Math.round(totalSalesSoFar / countUnits) : 0;

            for (let i = 0; i < labels.length; i++) {
                if (i <= currentLabelIndex) {
                    actualData.push(dataMap[labels[i]]); 
                    if (i === currentLabelIndex && currentLabelIndex < labels.length - 1) predictData.push(dataMap[labels[i]]);
                    else predictData.push(null);
                } else {
                    actualData.push(null); 
                    predictData.push(avgSales); 
                }
            }

            const total = filteredOrders.reduce((sum, r) => sum + (parseInt(r[3])||0), 0);
            const count = filteredOrders.length;
            const avg = count > 0 ? Math.round(total / count) : 0;

            document.getElementById('stat-total').innerText = total.toLocaleString();
            document.getElementById('stat-count').innerText = count;
            document.getElementById('stat-avg').innerText = avg.toLocaleString();

            if (chartSales) chartSales.destroy();
            const ctx = document.getElementById('chart-sales').getContext('2d');
            chartSales = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [
                        { label: '‡∏¢‡∏≠‡∏î‡∏Ç‡∏≤‡∏¢‡∏à‡∏£‡∏¥‡∏á (Actual)', data: actualData, borderColor: '#10b981', backgroundColor: 'rgba(16, 185, 129, 0.1)', borderWidth: 3, fill: true, tension: 0.4, pointBackgroundColor: '#10b981', pointRadius: 4 },
                        { label: '‡πÅ‡∏ô‡∏ß‡πÇ‡∏ô‡πâ‡∏°‡∏Ñ‡∏≤‡∏î‡∏Å‡∏≤‡∏£‡∏ì‡πå (Forecast)', data: predictData, borderColor: '#f59e0b', borderWidth: 2, borderDash: [5, 5], backgroundColor: 'transparent', fill: false, tension: 0.4, pointBackgroundColor: '#f59e0b', pointRadius: 0 }
                    ]
                },
                options: { 
                    responsive: true, maintainAspectRatio: false,
                    plugins: { legend: { position: 'top', labels: { usePointStyle: true, boxWidth: 8 } }, tooltip: { mode: 'index', intersect: false } },
                    scales: { y: { beginAtZero: true, grid: { borderDash: [2, 4] } }, x: { grid: { display: false } } },
                    interaction: { mode: 'nearest', axis: 'x', intersect: false }
                }
            });
        }

        // --- ORDERS LOGIC ---
        function handleOrdersPeriodChange() {
            const period = document.getElementById('orders-period').value;
            const customDateWrap = document.getElementById('orders-custom-date-wrap');
            if (period === 'custom') customDateWrap.classList.remove('hidden');
            else customDateWrap.classList.add('hidden');
            refreshOrders();
        }

        async function refreshOrders() {
            toggleLoading(true);
            try {
                const res = await fetch(`${SCRIPT_URL}?action=getOrders`);
                const data = await res.json();
                allOrders = data; 
                lastOrderCount = allOrders.length - 1;
                renderOrders();
            } catch(e) {}
            toggleLoading(false);
        }

        function renderOrders() {
            const container = document.getElementById('orders-list');
            container.innerHTML = '';
            let hasOrder = false;

            const period = document.getElementById('orders-period').value;
            const now = new Date();
            const yesterday = new Date(now); yesterday.setDate(yesterday.getDate() - 1);
            let customDate = new Date();
            
            if (period === 'custom') {
                const cdVal = document.getElementById('orders-custom-date').value;
                if(cdVal) customDate = new Date(cdVal);
            }

            for (let i = allOrders.length - 1; i >= 1; i--) {
                const row = allOrders[i];
                const originalIndex = i - 1; 
                
                const d = new Date(row[0]);
                let isMatch = false;

                if (period === 'all') isMatch = true;
                else if (period === 'today') isMatch = d.toDateString() === now.toDateString();
                else if (period === 'yesterday') isMatch = d.toDateString() === yesterday.toDateString();
                else if (period === 'custom') isMatch = d.toDateString() === customDate.toDateString();
                else if (period === 'week') {
                    const currentDay = now.getDay() === 0 ? 7 : now.getDay(); 
                    const monday = new Date(now); 
                    monday.setDate(now.getDate() - currentDay + 1);
                    monday.setHours(0,0,0,0);
                    isMatch = d >= monday && d.getTime() <= now.getTime() + 86400000;
                }
                else if (period === 'month') isMatch = d.getMonth() === now.getMonth() && d.getFullYear() === now.getFullYear();
                else if (period === 'quarter') {
                    const q = Math.floor((now.getMonth() + 3) / 3);
                    const rowQ = Math.floor((d.getMonth() + 3) / 3);
                    isMatch = q === rowQ && d.getFullYear() === now.getFullYear();
                }
                else if (period === 'year') isMatch = d.getFullYear() === now.getFullYear();

                if (!isMatch) continue;

                hasOrder = true;
                const status = row[5] || 'waiting';
                const time = row[6] || '';
                const slipUrl = row[4];
                
                let badge = `<span class="bg-amber-100 text-amber-600 px-3 py-1 rounded-full text-xs font-bold border border-amber-200">‡∏£‡∏≠‡∏£‡∏±‡∏ö</span>`;
                let action = `<button onclick="openTimeModal(${originalIndex})" class="bg-blue-500 text-white px-4 py-2 rounded-lg text-sm shadow font-bold hover:bg-blue-600 transition">‡∏£‡∏±‡∏ö‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå</button>`;

                if (status === 'cooking') {
                    badge = `<span class="bg-blue-100 text-blue-600 px-3 py-1 rounded-full text-xs font-bold border border-blue-200">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ó‡∏≥ (${time})</span>`;
                    action = `<button onclick="finishOrder(${originalIndex})" class="bg-emerald-500 text-white px-4 py-2 rounded-lg text-sm shadow font-bold hover:bg-emerald-600 transition">‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô</button>`;
                } else if (status === 'completed') {
                    badge = `<span class="bg-emerald-100 text-emerald-600 px-3 py-1 rounded-full text-xs font-bold border border-emerald-200">‡πÄ‡∏™‡∏£‡πá‡∏à‡πÅ‡∏•‡πâ‡∏ß</span>`;
                    action = `<span class="text-emerald-500 text-sm font-bold"><i class="fas fa-check"></i> ‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢</span>`;
                }

                let slipBtn = (slipUrl && slipUrl.includes('http')) 
                    ? `<button onclick="viewSlip('${slipUrl}')" class="text-blue-500 text-xs ml-2 bg-blue-50 px-2 py-1 rounded border border-blue-100 font-bold hover:bg-blue-200 transition"><i class="fas fa-receipt mr-1"></i> ‡∏î‡∏π‡∏™‡∏•‡∏¥‡∏õ</button>` 
                    : '<span class="text-slate-300 text-xs ml-2"><i class="fas fa-times-circle"></i> ‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏™‡∏•‡∏¥‡∏õ</span>';

                const html = `
                <div class="bg-white p-4 rounded-xl border border-slate-100 shadow-sm flex flex-col md:flex-row justify-between gap-4 ${status === 'completed' ? 'opacity-70 bg-slate-50' : ''} transition hover:shadow-md">
                    <div class="flex-1">
                        <div class="flex items-center gap-2 mb-2 flex-wrap">
                            <span class="font-bold text-lg text-emerald-600">‡πÇ‡∏ï‡πä‡∏∞ ${row[1]}</span>
                            <span class="text-slate-400 text-xs border px-1 rounded bg-white">${new Date(row[0]).toLocaleTimeString('th-TH', {hour:'2-digit', minute:'2-digit'})}</span>
                            ${badge}
                            ${slipBtn}
                        </div>
                        <p class="text-sm text-slate-600 mb-1 font-medium leading-relaxed">${row[2]}</p>
                        <p class="font-bold text-lg text-slate-800">‡∏ø${row[3]}</p>
                    </div>
                    <div class="flex items-center justify-end min-w-[100px]">${action}</div>
                </div>`;
                container.innerHTML += html;
            }

            if (!hasOrder) container.innerHTML = `<div class="text-center py-10 text-slate-400">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå‡πÉ‡∏ô‡∏£‡∏∞‡∏¢‡∏∞‡πÄ‡∏ß‡∏•‡∏≤‡∏ô‡∏µ‡πâ</div>`;
        }

        function viewSlip(url) {
            document.getElementById('modal-img-src').src = url;
            document.getElementById('image-modal').classList.remove('hidden');
        }

        // --- STOCK LOGIC ---
        async function refreshStock() {
            toggleLoading(true);
            try {
                const res = await fetch(`${SCRIPT_URL}?action=getMenu`);
                allMenu = await res.json();
                renderStock();
            } catch(e) {}
            toggleLoading(false);
        }

        function filterStock(type) {
            document.querySelectorAll('.stock-filter').forEach(b => {
                b.classList.remove('bg-emerald-500', 'text-white');
                b.classList.add('bg-white', 'text-slate-600');
                if((type === 'all' && b.innerText === '‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î') || (type === 'food' && b.innerText === '‡∏≠‡∏≤‡∏´‡∏≤‡∏£') || (type === 'drink' && b.innerText === '‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏î‡∏∑‡πà‡∏°') || (type === 'dessert' && b.innerText === '‡∏Ç‡∏≠‡∏á‡∏´‡∏ß‡∏≤‡∏ô')) {
                    b.classList.add('bg-emerald-500', 'text-white');
                    b.classList.remove('bg-white', 'text-slate-600');
                }
            });
            renderStock(type);
        }

        function renderStock(type = 'all') {
            const container = document.getElementById('stock-grid');
            container.innerHTML = '';
            
            allMenu.forEach(item => {
                if (type !== 'all' && item.type !== type) return;
                const isActive = item.status === true; 
                
                let stockDisplay = item.isUnlimited 
                    ? `<span class="bg-blue-100 text-blue-600 px-2 py-1 rounded text-xs font-bold">‚àû ‡πÑ‡∏°‡πà‡∏à‡∏≥‡∏Å‡∏±‡∏î</span>` 
                    : `<span class="${item.stock > 0 ? "bg-slate-100 text-slate-600" : "bg-red-100 text-red-600"} px-2 py-1 rounded text-xs font-bold">‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠: ${item.stock}</span>`;

                const html = `
                <div class="bg-white border border-slate-100 rounded-2xl p-3 shadow-sm hover:shadow-md transition relative overflow-hidden group">
                    <div class="flex gap-3">
                        <img src="${item.imgUrl}" class="w-20 h-20 rounded-lg object-cover bg-slate-100 ${!isActive ? 'grayscale' : ''}">
                        <div class="flex-1 min-w-0">
                            <h4 class="font-bold text-slate-800 truncate text-sm">${item.name}</h4>
                            <p class="text-emerald-500 font-bold text-sm">‡∏ø${item.price}</p>
                            <div class="flex gap-1 mt-1 flex-wrap">
                                <span class="text-[10px] bg-slate-100 px-2 py-0.5 rounded text-slate-500">${item.type}</span>
                                ${stockDisplay}
                            </div>
                        </div>
                    </div>
                    
                    <div class="mt-3 flex items-center justify-between border-t border-slate-50 pt-2">
                        <div class="flex items-center gap-2">
                            <span class="text-xs font-bold ${isActive ? 'text-emerald-500' : 'text-red-500'}">${isActive ? '‡∏Ç‡∏≤‡∏¢' : '‡∏´‡∏°‡∏î'}</span>
                            <div class="relative inline-block w-10 mr-2 align-middle select-none transition duration-200 ease-in">
                                <input type="checkbox" name="toggle" class="toggle-checkbox absolute block w-5 h-5 rounded-full bg-white border-4 appearance-none cursor-pointer transition-all duration-300 ${isActive ? 'right-0 border-emerald-400' : 'left-0 border-slate-300'}" 
                                    ${isActive ? 'checked' : ''} onclick="toggleStock('${item.name}', this)">
                                <label class="toggle-label block overflow-hidden h-5 rounded-full cursor-pointer ${isActive ? 'bg-emerald-400' : 'bg-slate-300'}"></label>
                            </div>
                        </div>
                        <div class="flex gap-1 opacity-0 group-hover:opacity-100 transition">
                            <button onclick='editItem(${JSON.stringify(item)})' class="p-2 text-blue-500 hover:bg-blue-50 rounded-lg"><i class="fas fa-edit"></i></button>
                            <button onclick="deleteProduct('${item.name}')" class="p-2 text-red-500 hover:bg-red-50 rounded-lg"><i class="fas fa-trash"></i></button>
                        </div>
                    </div>
                    ${!isActive ? '<div class="absolute inset-0 bg-white/40 pointer-events-none"></div>' : ''}
                </div>`;
                container.innerHTML += html;
            });
        }

        async function toggleStock(name, checkbox) {
            const newStatus = checkbox.checked;
            const label = checkbox.nextElementSibling;
            const textSpan = checkbox.parentElement.previousElementSibling;
            
            if(newStatus) {
                checkbox.classList.add('right-0', 'border-emerald-400'); checkbox.classList.remove('left-0', 'border-slate-300');
                label.classList.add('bg-emerald-400'); label.classList.remove('bg-slate-300');
                textSpan.innerText = "‡∏Ç‡∏≤‡∏¢"; textSpan.classList.add('text-emerald-500'); textSpan.classList.remove('text-red-500');
            } else {
                checkbox.classList.remove('right-0', 'border-emerald-400'); checkbox.classList.add('left-0', 'border-slate-300');
                label.classList.remove('bg-emerald-400'); label.classList.add('bg-slate-300');
                textSpan.innerText = "‡∏´‡∏°‡∏î"; textSpan.classList.remove('text-emerald-500'); textSpan.classList.add('text-red-500');
            }

            try {
                await fetch(SCRIPT_URL, { method: 'POST', body: JSON.stringify({ action: "toggleStock", name: name, status: newStatus }) });
            } catch(e) {
                alert("‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à");
                checkbox.checked = !newStatus;
            }
        }

        function toggleLoading(show) { document.getElementById('loading').style.display = show ? 'flex' : 'none'; }
        
        function openTimeModal(idx) {
            pendingRowIndex = idx;
            document.getElementById('time-modal').classList.remove('hidden');
        }
        async function selectTime(t) {
            document.getElementById('time-modal').classList.add('hidden');
            await updateStatus(pendingRowIndex, 'cooking', t);
        }
        async function finishOrder(idx) {
            if(confirm("‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô?")) await updateStatus(idx, 'completed', '');
        }
        async function updateStatus(idx, status, time) {
            toggleLoading(true);
            await fetch(SCRIPT_URL, { method: 'POST', body: JSON.stringify({ action: "updateOrderStatus", rowIndex: idx, status: status, estTime: time }) });
            refreshOrders(); 
            toggleLoading(false);
        }

        // --- Product Form Functions ---
        function openForm() { 
            document.getElementById('product-form').classList.remove('hidden'); 
            document.getElementById('edit-old-name').value=""; 
            document.getElementById('menu-name').value=""; 
            document.getElementById('menu-price').value=""; 
            document.getElementById('menu-desc').value=""; 
            document.getElementById('menu-stock').value = "";
            document.getElementById('menu-unlimited').checked = false;
            toggleStockInput();
        }
        
        function closeForm() { document.getElementById('product-form').classList.add('hidden'); }
        
        function editItem(item) {
            openForm();
            document.getElementById('form-title').innerText = "‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤";
            document.getElementById('edit-old-name').value = item.name;
            document.getElementById('menu-name').value = item.name;
            document.getElementById('menu-price').value = item.price;
            document.getElementById('menu-type').value = item.type;
            document.getElementById('menu-desc').value = item.description || "";
            document.getElementById('menu-stock').value = item.stock;
            document.getElementById('menu-unlimited').checked = item.isUnlimited;
            toggleStockInput();
        }
        
        function toggleStockInput() {
            const isUnlimited = document.getElementById('menu-unlimited').checked;
            const input = document.getElementById('menu-stock');
            if (isUnlimited) {
                input.disabled = true;
                input.classList.add('bg-slate-100', 'text-slate-400');
                input.classList.remove('bg-white');
                input.value = "";
            } else {
                input.disabled = false;
                input.classList.remove('bg-slate-100', 'text-slate-400');
                input.classList.add('bg-white');
            }
        }
        
        async function saveProduct() {
            toggleLoading(true);
            const name = document.getElementById('menu-name').value;
            const price = document.getElementById('menu-price').value;
            const oldName = document.getElementById('edit-old-name').value;
            const stock = document.getElementById('menu-stock').value;
            const isUnlimited = document.getElementById('menu-unlimited').checked;
            
            const file = document.getElementById('menu-image').files[0];
            let base64 = "";
            if(file) base64 = await toBase64(file);

            const payload = {
                action: oldName ? "updateItem" : "addItem",
                oldName: oldName,
                name: name, price: price,
                type: document.getElementById('menu-type').value,
                description: document.getElementById('menu-desc').value,
                imageFile: base64,
                stock: stock,
                isUnlimited: isUnlimited
            };
            await fetch(SCRIPT_URL, { method: 'POST', body: JSON.stringify(payload) });
            closeForm();
            refreshStock();
            toggleLoading(false);
        }

        async function deleteProduct(name) {
            if(!confirm("‡∏•‡∏ö‡πÄ‡∏°‡∏ô‡∏π‡∏ô‡∏µ‡πâ?")) return;
            toggleLoading(true);
            await fetch(SCRIPT_URL, { method: 'POST', body: JSON.stringify({ action: "deleteItem", name: name }) });
            refreshStock();
            toggleLoading(false);
        }

        function toBase64(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.readAsDataURL(file);
                reader.onload = () => resolve(reader.result);
                reader.onerror = error => reject(error);
            });
        }
    </script>
</body>
</html>
