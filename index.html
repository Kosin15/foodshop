<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>‡∏£‡πâ‡∏≤‡∏ô‡∏≠‡∏≤‡∏´‡∏≤‡∏£‡∏ô‡πâ‡∏≠‡∏á‡∏´‡∏ô‡∏∂‡πà‡∏áüê∞ü§ç - Quick Order</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css"/>
    <link href="https://fonts.googleapis.com/css2?family=Prompt:wght@300;400;500;600&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Prompt', sans-serif; -webkit-tap-highlight-color: transparent; }
        .loading-shimmer { background: linear-gradient(90deg, #f0fdf4 25%, #dcfce7 50%, #f0fdf4 75%); background-size: 200% 100%; animation: shimmer 1.5s infinite; }
        @keyframes shimmer { 0% { background-position: -200% 0; } 100% { background-position: 200% 0; } }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        .modal-enter { animation: slideUpModal 0.3s ease-out forwards; }
        @keyframes slideUpModal { from { transform: translateY(100%); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
        
        /* Table Map Grid */
        .table-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px; }
        .table-btn { aspect-ratio: 1; border-radius: 12px; display: flex; flex-direction: column; align-items: center; justify-content: center; background: #f1f5f9; border: 2px solid #e2e8f0; color: #64748b; font-weight: bold; transition: all 0.2s; }
        .table-btn.selected { background: #10b981; border-color: #059669; color: white; transform: scale(1.05); box-shadow: 0 4px 10px rgba(16, 185, 129, 0.3); }

        /* Timeline Styles */
        .timeline-line { position: absolute; left: 15px; top: 10px; bottom: 10px; width: 2px; background: #e2e8f0; z-index: 0; }
        .timeline-item { position: relative; z-index: 1; display: flex; align-items: flex-start; margin-bottom: 20px; }
        .timeline-dot { width: 32px; height: 32px; border-radius: 50%; background: #fff; border: 2px solid #cbd5e1; display: flex; align-items: center; justify-content: center; margin-right: 15px; flex-shrink: 0; transition: all 0.3s; }
        .timeline-dot.active { border-color: #10b981; background: #ecfdf5; color: #10b981; }
        .timeline-dot.completed { background: #10b981; border-color: #10b981; color: white; }
    </style>
</head>
<body class="bg-[#f7fafc] text-slate-700 pb-32">

    <audio id="success-sound" src="https://assets.mixkit.co/active_storage/sfx/2000/2000-preview.mp3"></audio>

    <div id="toast" class="fixed top-5 left-1/2 -translate-x-1/2 z-[150] px-6 py-3 rounded-2xl shadow-xl text-white font-bold hidden transition-all duration-300 w-max max-w-[90%] text-center">
        <span id="toast-msg"></span>
    </div>

    <div id="table-select-modal" class="fixed inset-0 bg-emerald-900/95 z-[200] flex items-center justify-center p-4 hidden">
        <div class="bg-white w-full max-w-sm rounded-3xl p-6 text-center shadow-2xl h-[85vh] flex flex-col">
            <h2 class="text-xl font-bold text-slate-800 mb-1">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ó‡∏µ‡πà‡∏ô‡∏±‡πà‡∏á‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì üê∞</h2>
            <p class="text-slate-400 text-sm mb-4">‡∏à‡∏¥‡πâ‡∏°‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ï‡πä‡∏∞‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏™‡∏±‡πà‡∏á‡∏≠‡∏≤‡∏´‡∏≤‡∏£</p>
            
            <div class="flex-1 overflow-y-auto no-scrollbar">
                <div class="table-grid" id="table-grid-container">
                    </div>
            </div>
            
            <div class="mt-4 pt-4 border-t border-slate-100">
                <p class="text-emerald-600 font-bold text-lg mb-3">‡πÇ‡∏ï‡πä‡∏∞‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å: <span id="selected-table-show" class="text-2xl">--</span></p>
                <button onclick="confirmTableSelection()" id="btn-confirm-table" class="w-full bg-slate-300 text-white py-4 rounded-xl font-bold text-lg cursor-not-allowed transition" disabled>‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô</button>
            </div>
        </div>
    </div>

    <div id="status-minimized" onclick="restoreStatusBar()" class="fixed z-40 hidden bottom-24 left-4 bg-white p-3 rounded-full shadow-lg border-4 border-emerald-500 cursor-pointer animate-bounce">
        <i class="fas fa-receipt text-emerald-600 text-xl"></i>
    </div>

    <div id="order-status-bar" class="fixed bottom-0 left-0 right-0 z-[100] bg-white rounded-t-3xl shadow-[0_-5px_30px_rgba(0,0,0,0.1)] p-6 hidden transition-transform transform translate-y-full">
        <div class="flex justify-between items-center mb-4">
            <h3 class="font-bold text-lg text-slate-800">‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå</h3>
            <div class="flex gap-2">
                <button onclick="minimizeStatusBar()" class="text-slate-400 hover:text-emerald-500 w-8 h-8 flex items-center justify-center bg-slate-100 rounded-full"><i class="fas fa-chevron-down"></i></button>
                <button onclick="closeStatusBarForever()" class="text-red-400 hover:text-red-500 w-8 h-8 flex items-center justify-center bg-red-50 rounded-full"><i class="fas fa-times"></i></button>
            </div>
        </div>
        <div class="relative pl-2" id="timeline-container">
            <div class="timeline-line"></div>
            </div>
    </div>

    <nav class="bg-emerald-600 text-white p-4 sticky top-0 z-50 shadow-lg flex justify-between items-center h-16">
        <div onclick="openTableSelector()" class="flex items-center gap-2 cursor-pointer bg-white/10 px-4 py-2 rounded-full active:scale-95">
            <span class="text-xl">üê∞</span> <span class="text-sm font-bold truncate max-w-[120px]" id="table-display">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÇ‡∏ï‡πä‡∏∞</span>
        </div>
        <div class="flex gap-2">
            <button onclick="openHistoryModal()" class="bg-white/10 p-2 rounded-full relative hover:bg-white/20 transition">
                <i class="fas fa-history text-lg"></i>
                <span id="history-badge" class="absolute top-0 right-0 w-2.5 h-2.5 bg-red-500 rounded-full hidden border border-white"></span>
            </button>
            <a href="admin.html" class="bg-white/10 p-2 rounded-full hover:bg-white/20 transition">
                <i class="fas fa-user-cog text-lg"></i>
            </a>
        </div>
    </nav>

    <div class="sticky top-16 z-40 bg-white/95 backdrop-blur py-2 shadow-sm border-b overflow-x-auto no-scrollbar flex px-4 gap-2">
        <button onclick="filterMenu('all')" class="filter-btn active bg-emerald-600 text-white px-4 py-1.5 rounded-full text-sm font-bold whitespace-nowrap">‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</button>
        <button onclick="filterMenu('food')" class="filter-btn bg-slate-100 text-slate-500 px-4 py-1.5 rounded-full text-sm font-bold whitespace-nowrap">‡∏≠‡∏≤‡∏´‡∏≤‡∏£</button>
        <button onclick="filterMenu('drink')" class="filter-btn bg-slate-100 text-slate-500 px-4 py-1.5 rounded-full text-sm font-bold whitespace-nowrap">‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏î‡∏∑‡πà‡∏°</button>
        <button onclick="filterMenu('dessert')" class="filter-btn bg-slate-100 text-slate-500 px-4 py-1.5 rounded-full text-sm font-bold whitespace-nowrap">‡∏Ç‡∏≠‡∏á‡∏´‡∏ß‡∏≤‡∏ô</button>
    </div>

    <div class="p-4 pb-24 max-w-md mx-auto min-h-screen space-y-8">
        <div id="section-food"><h2 class="text-lg font-bold text-slate-800 mb-3 flex items-center gap-2"><i class="fas fa-utensils text-emerald-500"></i> ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏≠‡∏≤‡∏´‡∏≤‡∏£</h2><div id="food-list" class="space-y-3"></div></div>
        <div id="section-drink"><h2 class="text-lg font-bold text-slate-800 mb-3 flex items-center gap-2"><i class="fas fa-glass-water text-blue-500"></i> ‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏î‡∏∑‡πà‡∏°</h2><div id="drink-list" class="space-y-3"></div></div>
        <div id="section-dessert"><h2 class="text-lg font-bold text-slate-800 mb-3 flex items-center gap-2"><i class="fas fa-ice-cream text-pink-500"></i> ‡∏Ç‡∏≠‡∏á‡∏´‡∏ß‡∏≤‡∏ô</h2><div id="dessert-list" class="space-y-3"></div></div>
    </div>

    <div id="cart-bar" class="fixed bottom-0 left-0 right-0 bg-white border-t p-4 shadow-lg hidden z-40">
        <div class="flex justify-between items-center bg-emerald-600 text-white p-4 rounded-2xl shadow-emerald-200 shadow-xl cursor-pointer" onclick="openCartModal()">
            <div class="flex items-center gap-3">
                <div class="bg-white/20 w-10 h-10 rounded-full flex items-center justify-center font-bold" id="cart-count">0</div>
                <div class="flex flex-col"><span class="text-xs opacity-80">‡∏¢‡∏≠‡∏î‡∏£‡∏ß‡∏°</span><span class="font-bold text-lg">‡∏ø<span id="cart-total">0</span></span></div>
            </div>
            <span class="font-bold">‡∏î‡∏π‡∏ï‡∏∞‡∏Å‡∏£‡πâ‡∏≤ <i class="fas fa-chevron-right ml-1"></i></span>
        </div>
    </div>

    <div id="cart-modal" class="fixed inset-0 bg-black/50 hidden z-[60] flex items-end justify-center backdrop-blur-sm">
        <div class="bg-white w-full max-w-md p-6 rounded-t-3xl h-[85vh] flex flex-col modal-enter">
            <div class="flex justify-between items-center mb-4 border-b pb-4">
                <h3 class="text-2xl font-bold">‡∏ï‡∏∞‡∏Å‡∏£‡πâ‡∏≤‡∏Ç‡∏≠‡∏á‡∏â‡∏±‡∏ô</h3>
                <button onclick="closeCartModal()" class="w-8 h-8 bg-slate-100 rounded-full hover:bg-slate-200 transition"><i class="fas fa-times"></i></button>
            </div>
            <div id="cart-items-container" class="flex-1 overflow-y-auto space-y-4 pr-1"></div>
            <div class="mt-4 pt-4 border-t">
                <div class="flex justify-between items-center mb-4">
                    <span class="text-slate-500 font-bold">‡∏¢‡∏≠‡∏î‡∏™‡∏∏‡∏ó‡∏ò‡∏¥</span>
                    <span class="text-3xl font-bold text-emerald-600">‡∏ø<span id="modal-total">0</span></span>
                </div>
                <button onclick="goToPayment()" class="w-full bg-emerald-600 text-white py-4 rounded-xl font-bold text-lg shadow-lg hover:bg-emerald-700 transition">‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏™‡∏±‡πà‡∏á</button>
            </div>
        </div>
    </div>

    <div id="payment-modal" class="fixed inset-0 bg-black/60 hidden z-[70] flex items-center justify-center p-4 backdrop-blur-sm">
        <div class="bg-white rounded-3xl w-full max-w-sm p-6 text-center shadow-2xl relative">
            <button onclick="backToCart()" class="absolute top-4 right-4 text-slate-400 hover:bg-slate-100 w-8 h-8 rounded-full"><i class="fas fa-times"></i></button>
            <h3 class="text-xl font-bold mb-4">‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô</h3>
            <div class="bg-slate-50 p-4 rounded-xl border-2 border-dashed border-slate-200 mb-4">
                <img id="qr-image" src="https://placehold.co/200x200?text=Generating+QR..." class="w-48 h-48 mx-auto rounded-lg mb-2 bg-white">
                <p class="text-xs text-slate-400">PromptPay</p>
            </div>
            <div class="mb-4 text-left">
                <label class="text-xs font-bold text-slate-500 mb-1 block">‡πÅ‡∏ô‡∏ö‡∏™‡∏•‡∏¥‡∏õ (‡∏ñ‡πâ‡∏≤‡∏°‡∏µ)</label>
                <input type="file" id="slip-input" accept="image/*" class="w-full text-xs file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-xs file:font-bold file:bg-emerald-50 file:text-emerald-700 border rounded-lg p-1 cursor-pointer">
            </div>
            <div class="text-3xl font-bold text-emerald-600 mb-6">‡∏ø<span id="pay-total">0</span></div>
            <button id="btn-submit-order" onclick="confirmOrder()" class="w-full bg-emerald-600 text-white py-3 rounded-xl font-bold hover:bg-emerald-700 transition">‡πÅ‡∏à‡πâ‡∏á‡πÇ‡∏≠‡∏ô‡πÄ‡∏á‡∏¥‡∏ô</button>
        </div>
    </div>

    <div id="history-modal" class="fixed inset-0 bg-black/50 hidden z-[80] flex items-end justify-center">
        <div class="bg-white w-full max-w-md p-6 rounded-t-3xl h-[70vh] flex flex-col modal-enter">
            <div class="flex justify-between mb-4 pb-2 border-b"><h3 class="font-bold text-lg">‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏™‡∏±‡πà‡∏á</h3><button onclick="closeHistoryModal()"><i class="fas fa-times"></i></button></div>
            <div id="history-container" class="flex-1 overflow-y-auto space-y-3"></div>
            <div class="mt-4 pt-2 text-center border-t">
                <button onclick="clearHistory()" class="text-red-400 text-sm underline">‡∏•‡πâ‡∏≤‡∏á‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥</button>
            </div>
        </div>
    </div>

    <script>
        const PROMPTPAY_ID = "0927899880"; 
        const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbwPX7-03fHsRh63WwTdLEU-RzSRUPwBpCCFVKVKDMBpiRbz-2H7L_ytpEZA17TADcWPBw/exec'; 
        
        let cartItems = [];
        let orderHistory = JSON.parse(localStorage.getItem('orderHistory')) || [];
        let serverOrderStatuses = [];
        let tempSelectedTable = null;
        let isFirstLoad = true;
        let isStatusClosed = false; 
        
        // üî• ‡∏ï‡∏±‡∏ß‡πÅ‡∏õ‡∏£‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏Å‡∏î‡∏õ‡∏∏‡πà‡∏°‡∏™‡∏±‡πà‡∏á‡∏≠‡∏≤‡∏´‡∏≤‡∏£‡∏ã‡πâ‡∏≥‡∏£‡∏±‡∏ß‡πÜ (Double Submit Prevention)
        let isSubmittingOrder = false;

        function newSearchParams(search) { return new URLSearchParams(search); }
        let tableNumber = newSearchParams(window.location.search).get('table');

        document.addEventListener('DOMContentLoaded', () => {
            renderTableGrid();
            if (!tableNumber || tableNumber === "NaN") {
                openTableSelector();
            } else {
                document.getElementById('table-display').innerText = `‡πÇ‡∏ï‡πä‡∏∞ ${tableNumber}`;
                startStatusCheck();
            }
            loadMenu();
        });

        // 1. Table Map Logic
        function renderTableGrid() {
            const container = document.getElementById('table-grid-container');
            container.innerHTML = '';
            for (let i = 1; i <= 20; i++) {
                container.innerHTML += `<button onclick="selectTable(${i})" class="table-btn" id="tbl-${i}">${i}</button>`;
            }
        }
        function openTableSelector() { document.getElementById('table-select-modal').classList.remove('hidden'); }
        function selectTable(num) {
            document.querySelectorAll('.table-btn').forEach(b => b.classList.remove('selected'));
            document.getElementById(`tbl-${num}`).classList.add('selected');
            tempSelectedTable = num;
            document.getElementById('selected-table-show').innerText = num;
            const btn = document.getElementById('btn-confirm-table');
            btn.classList.remove('bg-slate-300', 'cursor-not-allowed');
            btn.classList.add('bg-emerald-600', 'hover:bg-emerald-700');
            btn.disabled = false;
        }
        function confirmTableSelection() {
            if(!tempSelectedTable) return;
            tableNumber = tempSelectedTable;
            document.getElementById('table-display').innerText = `‡πÇ‡∏ï‡πä‡∏∞ ${tableNumber}`;
            document.getElementById('table-select-modal').classList.add('hidden');
            const newUrl = window.location.pathname + '?table=' + tableNumber;
            window.history.pushState({path:newUrl},'',newUrl);
            startStatusCheck();
        }

        // 2. Timeline Status Logic
        function minimizeStatusBar() {
            document.getElementById('order-status-bar').classList.remove('translate-y-0');
            document.getElementById('order-status-bar').classList.add('translate-y-full');
            document.getElementById('status-minimized').classList.remove('hidden');
        }
        function restoreStatusBar() {
            document.getElementById('order-status-bar').classList.remove('hidden', 'translate-y-full');
            document.getElementById('order-status-bar').classList.add('translate-y-0');
            document.getElementById('status-minimized').classList.add('hidden');
            isStatusClosed = false;
        }
        function closeStatusBarForever() {
            document.getElementById('order-status-bar').classList.add('hidden');
            document.getElementById('status-minimized').classList.add('hidden');
            isStatusClosed = true; 
        }

        function renderTimeline(status, time, orderTime) {
            const container = document.getElementById('timeline-container');
            let step1Class = 'completed', step2Class = '', step3Class = '';
            let step1Icon = '<i class="fas fa-check"></i>', step2Icon = '2', step3Icon = '3';
            
            if (status === 'cooking') {
                step2Class = 'active'; step2Icon = '<i class="fas fa-fire fa-beat"></i>';
            } else if (status === 'completed') {
                step2Class = 'completed'; step2Icon = '<i class="fas fa-check"></i>';
                step3Class = 'completed'; step3Icon = '<i class="fas fa-utensils"></i>';
            }

            const formatTime = (iso) => iso ? new Date(iso).toLocaleTimeString('th-TH', {hour:'2-digit', minute:'2-digit'}) : '--:--';

            container.innerHTML = `
                <div class="timeline-line"></div>
                <div class="timeline-item">
                    <div class="timeline-dot ${step1Class}">${step1Icon}</div>
                    <div><p class="font-bold text-sm">‡∏£‡∏±‡∏ö‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå</p><p class="text-xs text-slate-400">${formatTime(orderTime)}</p></div>
                </div>
                <div class="timeline-item">
                    <div class="timeline-dot ${step2Class}">${step2Icon}</div>
                    <div><p class="font-bold text-sm ${status==='cooking'?'text-emerald-600':''}">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏õ‡∏£‡∏∏‡∏á</p><p class="text-xs text-slate-400">${status==='cooking' ? (time || '‡∏£‡∏≠‡∏™‡∏±‡∏Å‡∏Ñ‡∏£‡∏π‡πà') : ''}</p></div>
                </div>
                <div class="timeline-item">
                    <div class="timeline-dot ${step3Class}">${step3Icon}</div>
                    <div><p class="font-bold text-sm">‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô</p><p class="text-xs text-slate-400">${status==='completed'?'‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÄ‡∏™‡∏¥‡∏£‡πå‡∏ü':''}</p></div>
                </div>
            `;
            
            if (!isStatusClosed) {
                document.getElementById('order-status-bar').classList.remove('hidden', 'translate-y-full');
            }
        }

        async function checkStatus() {
            if(!tableNumber) return;
            try {
                const res = await fetch(`${SCRIPT_URL}?action=checkStatus&table=${tableNumber}`);
                const data = await res.json();
                if(data.orders && data.orders.length > 0) {
                    serverOrderStatuses = data.orders;
                    const latest = data.orders[data.orders.length - 1];
                    
                    if(latest.status !== 'waiting' || isFirstLoad) {
                        renderTimeline(latest.status, latest.estTime, latest.orderTime);
                    }

                    const completed = data.orders.filter(o => o.status === 'completed').length;
                    const storedCompleted = parseInt(localStorage.getItem('completedCount') || 0);
                    
                    if (completed > storedCompleted && !isFirstLoad) {
                        playNotification(); 
                    }
                    localStorage.setItem('completedCount', completed);
                    isFirstLoad = false;
                }
            } catch(e) {}
        }

        // 3. Menu & Cart Logic
        async function loadMenu() {
            try {
                const res = await fetch(`${SCRIPT_URL}?action=getMenu`); const menu = await res.json();
                ['food', 'drink', 'dessert'].forEach(t => document.getElementById(t + '-list').innerHTML = '');
                menu.forEach(item => {
                    const isActive = item.status; const hasStock = item.isUnlimited || item.stock > 0;
                    let btn = !isActive ? '<span class="text-xs text-slate-300 border border-slate-200 px-3 py-1 rounded-lg">‡∏õ‡∏¥‡∏î‡∏£‡∏±‡∏ö</span>' : (!hasStock ? '<span class="text-xs text-red-500 bg-red-50 px-3 py-1 rounded-lg font-bold">‡∏´‡∏°‡∏î</span>' : `<button onclick="addToCart('${item.name}', ${item.price}, '${item.imgUrl}')" class="bg-emerald-600 hover:bg-emerald-700 text-white px-4 py-1.5 rounded-lg text-xs font-bold transition shadow-sm active:scale-95">+ ‡πÄ‡∏û‡∏¥‡πà‡∏°</button>`);
                    let html = `
                    <div class="bg-white p-3 rounded-2xl shadow-[0_2px_10px_rgba(0,0,0,0.03)] border border-slate-100 flex gap-3 h-[100px]">
                        <img src="${item.imgUrl}" class="w-20 h-full rounded-xl object-cover bg-slate-50 ${(!isActive||!hasStock)?'grayscale opacity-50':''}" onerror="this.src='https://placehold.co/150?text=Image'">
                        <div class="flex-1 flex flex-col justify-between py-0.5">
                            <div>
                                <h4 class="font-bold text-sm text-slate-800 leading-tight mb-1">${item.name}</h4>
                                <p class="text-[10px] text-slate-400 line-clamp-1">${item.description||''}</p>
                            </div>
                            <div class="flex justify-between items-center">
                                <span class="text-emerald-600 font-bold text-base">‡∏ø${item.price}</span>
                                ${btn}
                            </div>
                        </div>
                    </div>`;
                    document.getElementById(item.type + '-list').innerHTML += html;
                });
            } catch(e){}
        }

        function addToCart(name, price, img) {
            const existingItem = cartItems.find(item => item.name === name);
            if (existingItem) {
                existingItem.qty++;
            } else {
                cartItems.push({ name, price, img, qty: 1, note: '' });
            }
            updateCartUI(); 
            showToast(`‡πÄ‡∏û‡∏¥‡πà‡∏° ${name} ‡∏•‡∏á‡∏ï‡∏∞‡∏Å‡∏£‡πâ‡∏≤‡πÅ‡∏•‡πâ‡∏ß`, true);
        }

        function updateCartUI() {
            const totalQty = cartItems.reduce((s, i) => s + i.qty, 0); 
            const totalAmount = cartItems.reduce((s, i) => s + (i.price * i.qty), 0);
            
            document.getElementById('cart-bar').classList.toggle('hidden', cartItems.length === 0);
            document.getElementById('cart-count').innerText = totalQty;
            document.getElementById('cart-total').innerText = totalAmount.toLocaleString();
            
            document.getElementById('pay-total').innerText = totalAmount.toLocaleString();
            document.getElementById('modal-total').innerText = totalAmount.toLocaleString();
        }

        function openCartModal() {
            const el = document.getElementById('cart-items-container'); 
            el.innerHTML = '';
            
            if(cartItems.length === 0) { 
                el.innerHTML = '<div class="text-center py-10"><i class="fas fa-shopping-basket text-slate-200 text-4xl mb-2"></i><p class="text-slate-400 font-medium text-sm">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏≠‡∏≤‡∏´‡∏≤‡∏£</p></div>'; 
                return; 
            }
            
            cartItems.forEach((item, idx) => {
                el.innerHTML += `
                <div class="bg-slate-50 p-3 rounded-2xl mb-3 border border-slate-100 shadow-sm relative">
                    <div class="flex gap-3 items-center mb-3">
                        <img src="${item.img}" class="w-14 h-14 rounded-xl object-cover bg-white border border-slate-200">
                        <div class="flex-1">
                            <h4 class="font-bold text-sm text-slate-800 leading-tight">${item.name}</h4>
                            <p class="text-emerald-600 font-bold text-sm mt-1">‡∏ø${item.price}</p>
                        </div>
                        <div class="flex flex-col items-end gap-2">
                            <div class="flex items-center bg-white rounded-lg border border-slate-200 shadow-sm overflow-hidden h-8">
                                <button onclick="changeQty(${idx}, -1)" class="w-8 h-full text-red-500 hover:bg-red-50 transition flex items-center justify-center border-r border-slate-100"><i class="fas fa-minus text-xs"></i></button>
                                <span class="w-8 text-center font-bold text-sm text-slate-700">${item.qty}</span>
                                <button onclick="changeQty(${idx}, 1)" class="w-8 h-full text-emerald-500 hover:bg-emerald-50 transition flex items-center justify-center border-l border-slate-100"><i class="fas fa-plus text-xs"></i></button>
                            </div>
                        </div>
                    </div>
                    <div class="flex gap-2 items-center">
                        <i class="fas fa-comment-dots text-slate-300"></i>
                        <input type="text" placeholder="‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏ (‡πÄ‡∏ä‡πà‡∏ô ‡πÑ‡∏°‡πà‡πÄ‡∏ú‡πá‡∏î, ‡∏´‡∏ß‡∏≤‡∏ô‡∏ô‡πâ‡∏≠‡∏¢)" class="w-full text-xs p-2 rounded-lg border border-slate-200 focus:outline-none focus:border-emerald-500 transition bg-white" value="${item.note}" onchange="updateNote(${idx}, this.value)">
                        <button onclick="removeItem(${idx})" class="w-8 h-8 rounded-lg bg-white border border-slate-200 text-slate-300 hover:text-red-500 hover:border-red-200 hover:bg-red-50 transition flex-shrink-0 flex items-center justify-center"><i class="fas fa-trash text-xs"></i></button>
                    </div>
                </div>`;
            });
            document.getElementById('cart-modal').classList.remove('hidden');
        }
        
        function updateNote(idx, val) { cartItems[idx].note = val; }
        
        function changeQty(index, delta) { 
            cartItems[index].qty += delta; 
            if (cartItems[index].qty <= 0) { 
                if(confirm("‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡πÄ‡∏°‡∏ô‡∏π‡∏ô‡∏µ‡πâ‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏ï‡∏∞‡∏Å‡∏£‡πâ‡∏≤‡πÉ‡∏ä‡πà‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?")) {
                    cartItems.splice(index, 1); 
                } else {
                    cartItems[index].qty = 1; 
                }
            } 
            if (cartItems.length === 0) closeCartModal(); 
            else openCartModal(); 
            
            updateCartUI(); 
        }

        function removeItem(index) { 
            if(confirm("‡∏•‡∏ö‡πÄ‡∏°‡∏ô‡∏π‡∏ô‡∏µ‡πâ‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏ï‡∏∞‡∏Å‡∏£‡πâ‡∏≤?")) { 
                cartItems.splice(index, 1); 
                if (cartItems.length === 0) closeCartModal(); 
                else openCartModal(); 
                updateCartUI(); 
            } 
        }
        
        function closeCartModal() { document.getElementById('cart-modal').classList.add('hidden'); }
        
        function goToPayment() { 
            if(cartItems.length === 0) return;
            closeCartModal(); 
            document.getElementById('payment-modal').classList.remove('hidden'); 
            const total = cartItems.reduce((s, i) => s + (i.price * i.qty), 0);
            const qrUrl = `https://promptpay.io/${PROMPTPAY_ID}/${total}`;
            document.getElementById('qr-image').src = qrUrl;
        }
        
        function backToCart() { document.getElementById('payment-modal').classList.add('hidden'); document.getElementById('cart-modal').classList.remove('hidden'); }

        // üî• ‡∏•‡πá‡∏≠‡∏Å‡∏õ‡∏∏‡πà‡∏°‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏™‡πà‡∏á‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå‡πÄ‡∏ö‡∏¥‡πâ‡∏• (Double Submit Prevention)
        async function confirmOrder() {
            if (isSubmittingOrder) return; // ‡∏ñ‡πâ‡∏≤‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏™‡πà‡∏á‡∏≠‡∏¢‡∏π‡πà ‡∏´‡πâ‡∏≤‡∏°‡∏ó‡∏≥‡∏ã‡πâ‡∏≥
            
            const btn = document.getElementById('btn-submit-order'); 
            const originalText = btn.innerText;
            
            isSubmittingOrder = true; // ‡∏•‡πá‡∏≠‡∏Å‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞
            btn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i> ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...'; 
            btn.disabled = true;
            btn.classList.add('opacity-70', 'cursor-not-allowed');

            try {
                const file = document.getElementById('slip-input').files[0];
                let base64 = ""; if(file) base64 = await toBase64(file);
                
                const menuString = cartItems.map(i => `${i.name} ${i.note ? '('+i.note+')' : ''} x${i.qty}`).join(", ");
                const total = cartItems.reduce((s, i) => s + (i.price * i.qty), 0);

                await fetch(SCRIPT_URL, {
                    method: 'POST', body: JSON.stringify({
                        table: tableNumber, menuItems: menuString, totalPrice: total, slipImage: base64, cartData: cartItems
                    })
                });
                
                orderHistory.push({ time: new Date().toLocaleTimeString('th-TH', {hour:'2-digit', minute:'2-digit'}), total: total, items: [...cartItems] });
                localStorage.setItem('orderHistory', JSON.stringify(orderHistory));
                
                showToast("‡∏™‡∏±‡πà‡∏á‡∏≠‡∏≤‡∏´‡∏≤‡∏£‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à! ‡πÇ‡∏õ‡∏£‡∏î‡∏£‡∏≠‡∏™‡∏±‡∏Å‡∏Ñ‡∏£‡∏π‡πà", true); 
                cartItems=[]; 
                updateCartUI(); 
                document.getElementById('payment-modal').classList.add('hidden');
                document.getElementById('slip-input').value = ""; // ‡πÄ‡∏Ñ‡∏•‡∏µ‡∏¢‡∏£‡πå‡∏ä‡πà‡∏≠‡∏á‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡∏™‡∏•‡∏¥‡∏õ
                
                isStatusClosed = false;
                checkStatus();
            } catch(e) { 
                showToast("‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏•‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà", false); 
            } finally { 
                // ‡∏Ñ‡∏∑‡∏ô‡∏Ñ‡πà‡∏≤‡∏õ‡∏∏‡πà‡∏°‡πÉ‡∏´‡πâ‡∏Å‡∏•‡∏±‡∏ö‡∏°‡∏≤‡πÄ‡∏õ‡πá‡∏ô‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô‡πÄ‡∏î‡∏¥‡∏°‡πÄ‡∏ú‡∏∑‡πà‡∏≠‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏î‡πÉ‡∏´‡∏°‡πà
                btn.innerHTML = originalText; 
                btn.disabled = false; 
                btn.classList.remove('opacity-70', 'cursor-not-allowed');
                isSubmittingOrder = false; // ‡∏õ‡∏•‡∏î‡∏•‡πá‡∏≠‡∏Å
            }
        }

        // Utils
        function showToast(m, s) { 
            const t = document.getElementById('toast'); 
            t.className = `fixed top-5 left-1/2 -translate-x-1/2 z-[150] px-6 py-3 rounded-2xl shadow-xl text-white font-bold transition-all duration-300 w-max max-w-[90%] text-center ${s?'bg-emerald-500':'bg-red-500'}`;
            document.getElementById('toast-msg').innerText = m; t.classList.remove('hidden');
            setTimeout(()=>t.classList.add('hidden'), 3000);
        }
        
        function filterMenu(t) {
            document.querySelectorAll('.filter-btn').forEach(b => { b.classList.remove('bg-emerald-600','text-white'); b.classList.add('bg-slate-100','text-slate-500'); });
            event.target.classList.remove('bg-slate-100','text-slate-500'); event.target.classList.add('bg-emerald-600','text-white');
            ['food','drink','dessert'].forEach(ID => document.getElementById('section-'+ID).style.display = (t==='all'||t===ID)?'block':'none');
        }
        
        function playNotification() { 
            document.getElementById('success-sound').play().catch(()=>{}); 
            document.getElementById('history-badge').classList.remove('hidden'); 
        }
        
        function toBase64(file) { return new Promise((r, j) => { const reader = new FileReader(); reader.readAsDataURL(file); reader.onload = () => r(reader.result); reader.onerror = j; }); }
        
        function openHistoryModal() {
            document.getElementById('history-badge').classList.add('hidden');
            const c = document.getElementById('history-container'); c.innerHTML = '';
            orderHistory.slice().reverse().forEach(o => {
                c.innerHTML += `<div class="bg-slate-50 p-3 rounded-xl mb-2 border border-slate-100"><div class="flex justify-between text-xs text-slate-400 mb-1"><span><i class="fas fa-clock mr-1"></i> ${o.time}</span><span class="text-emerald-600 font-bold">‡∏ø${o.total.toLocaleString()}</span></div><div class="text-sm font-medium text-slate-700 leading-tight">${o.items.map(i=>`${i.name} (x${i.qty})`).join(', ')}</div></div>`;
            });
            document.getElementById('history-modal').classList.remove('hidden');
        }
        
        function closeHistoryModal() { document.getElementById('history-modal').classList.add('hidden'); }
        function clearHistory() { if(confirm("‡∏•‡πâ‡∏≤‡∏á‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î?")) { orderHistory = []; localStorage.removeItem('orderHistory'); openHistoryModal(); } }
        function startStatusCheck() { checkStatus(); setInterval(checkStatus, 5000); }
    </script>
</body>
</html>
